name: Run Top10 Decision (Auto Daily)

on:
  schedule:
    # Mon-Fri 21:15 Beijing (UTC+8) == 13:15 UTC
    - cron: "15 13 * * 1-5"
  workflow_dispatch:
    inputs:
      trade_date:
        description: "手动指定交易日 YYYYMMDD（留空=使用 a-top10 latest）"
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: top10-decision-daily
  cancel-in-progress: false

jobs:
  decision:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=${GITHUB_WORKSPACE}/src" >> $GITHUB_ENV

      # ✅ 关键：先把会产生/会落库/会发布的目录建好，避免脚本/commit 阶段因为目录不存在而漏产物
      - name: Ensure output dirs
        run: |
          set -e
          mkdir -p data/pred
          mkdir -p data/decision
          mkdir -p docs/signals
          mkdir -p docs/reports
          mkdir -p docs/weights
          mkdir -p outputs/decision
          mkdir -p outputs/learning

      # 先同步 latest（保底）
      - name: Sync latest pred_top10 from a-top10 (retry)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          A_TOP10_OWNER: njedu2023-prog
          A_TOP10_REPO: a-top10
          A_TOP10_BRANCH: main
          A_TOP10_DIR: outputs/learning
        run: |
          set -e
          for i in 1 2 3; do
            echo "[sync] attempt $i/3"
            python scripts/sync_from_a_top10.py && break
            echo "[sync] failed attempt $i/3"
            sleep 5
          done

      # ✅ 手动指定日期：拉取 pred_top10_{trade_date}.csv，并覆盖为 pred_top10_latest.csv
      - name: If trade_date provided, fetch pred_top10_{trade_date}.csv and overwrite latest
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.trade_date != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          A_TOP10_OWNER: njedu2023-prog
          A_TOP10_REPO: a-top10
          A_TOP10_BRANCH: main
          TRADE_DATE: ${{ inputs.trade_date }}
        run: |
          set -e

          echo "[manual] trade_date=${TRADE_DATE}"

          # 基础校验：8位数字
          if ! echo "${TRADE_DATE}" | grep -E '^[0-9]{8}$' >/dev/null; then
            echo "[manual] invalid trade_date: ${TRADE_DATE} (expect YYYYMMDD)"
            exit 1
          fi

          mkdir -p data/pred

          # ✅ a-top10 文件名：pred_top10_YYYYMMDD.csv
          FILE_IN_A_TOP10="outputs/learning/pred_top10_${TRADE_DATE}.csv"
          RAW_URL="https://raw.githubusercontent.com/${A_TOP10_OWNER}/${A_TOP10_REPO}/${A_TOP10_BRANCH}/${FILE_IN_A_TOP10}"

          echo "[manual] fetching: ${RAW_URL}"

          # 注：仓库为 public 时其实不需要 token；保留 header 仅用于更稳的限流/访问
          curl -fL \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3.raw" \
            "${RAW_URL}" \
            -o "data/pred/pred_top10_latest.csv"

          echo "[manual] overwritten data/pred/pred_top10_latest.csv from pred_top10_${TRADE_DATE}.csv"
          echo "[manual] head:"
          head -n 3 data/pred/pred_top10_latest.csv || true

      - name: Run decision pipeline (P0)
        run: |
          set -e
          python scripts/run_v2.py

      - name: Commit & push outputs (safe)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 先更新远端，避免 push 冲突
          git pull --rebase origin main || true

          # 双保险：清理 pycache（就算生成也不让它影响提交）
          find . -type d -name "__pycache__" -prune -exec rm -rf {} + || true
          find . -type f -name "*.pyc" -delete || true

          # 也写入 exclude，防止未来其它步骤又生成
          echo "__pycache__/" >> .git/info/exclude
          echo "*.pyc" >> .git/info/exclude

          # ✅ 精准 add：把所有需要落库/发布的产物全纳入
          # --- a-top10 同步输入快照（可追溯）
          git add data/pred/pred_top10_latest.csv || true
          git add data/pred/pred_top10_*.csv || true

          # --- decision 输出（你定义的“可执行权重 + 决策报告 + 评估”）
          git add docs/weights/weights_latest.csv || true
          git add docs/weights/weights_*.csv || true

          git add outputs/decision/* || true
          git add outputs/decision/**/*.md || true
          git add outputs/decision/**/*.json || true

          # --- 三张必落库表（自学习不跑偏）
          git add data/decision/decision_candidates_*.csv || true
          git add data/decision/decision_execution_*.csv || true
          git add data/decision/decision_learning.csv || true

          # ✅ signals：latest + dated（永远新增）都纳入
          git add docs/signals/top10_latest.csv || true
          git add docs/signals/top10_*.csv || true

          # ✅ 日报（覆盖版 + 归档版）都纳入
          git add docs/reports/*.md || true
          git add -A docs/reports || true

          echo "[git] status after add:"
          git status --porcelain || true

          # 仅当有变更时提交
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "auto: update decision signal"
            git push
            echo "[push] done"
          else
            echo "[push] no changes"
          fi
