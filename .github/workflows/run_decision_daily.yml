name: Run Top10 Decision (Auto Daily)

on:
  schedule:
    # Mon-Fri 21:15 Beijing (UTC+8) == 13:15 UTC
    - cron: "15 13 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: top10-decision-daily
  cancel-in-progress: false

jobs:
  decision:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 关键：让 Python 能 import src/top10decision
      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=${GITHUB_WORKSPACE}/src" >> $GITHUB_ENV

      # 关键：同步 a-top10 的最新 pred 文件（带重试）
      - name: Sync latest pred_top10 from a-top10 (retry)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          A_TOP10_OWNER: njedu2023-prog
          A_TOP10_REPO: a-top10
          A_TOP10_BRANCH: main
          A_TOP10_DIR: outputs/learning
        run: |
          set -e
          for i in 1 2 3; do
            echo "[sync] attempt $i/3"
            python scripts/sync_from_a_top10.py && break
            echo "[sync] failed attempt $i/3"
            sleep 5
          done

      # 决策 + 写出 docs/signals/top10_latest.csv + docs/reports/daily_latest.md
      - name: Run decision pipeline (P0)
        run: |
          set -e
          python scripts/run_v2.py

      # 推送前先 pull/rebase，避免冲突；仅有变化才 commit
      - name: Commit & push outputs (safe)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 先更新远端，避免 push 冲突
          git pull --rebase origin main || true

          # 精准 add：只 add 我们产生的产物
          git add data/pred/pred_top10_latest.csv || true
          git add data/pred/pred_top10_*.csv || true
          git add docs/signals/top10_latest.csv || true
          git add docs/reports/daily_latest.md || true

          # 仅当有变更时提交
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "auto: update decision signal"
            git push
            echo "[push] done"
          else
            echo "[push] no changes"
          fi
