name: Run Top10 Decision (Auto Daily)

on:
  schedule:
    # Mon-Fri 21:15 Beijing (UTC+8) == 13:15 UTC
    - cron: "15 13 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: top10-decision-daily
  cancel-in-progress: false

jobs:
  decision:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=${GITHUB_WORKSPACE}/src" >> $GITHUB_ENV

      - name: Sync latest pred_top10 from a-top10 (retry)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          A_TOP10_OWNER: njedu2023-prog
          A_TOP10_REPO: a-top10
          A_TOP10_BRANCH: main
          A_TOP10_DIR: outputs/learning
        run: |
          set -e
          for i in 1 2 3; do
            echo "[sync] attempt $i/3"
            python scripts/sync_from_a_top10.py && break
            echo "[sync] failed attempt $i/3"
            sleep 5
          done

      - name: Run decision pipeline (P0)
        run: |
          set -e
          python scripts/run_v2.py

      - name: Commit & push outputs (safe)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 先更新远端，避免 push 冲突
          git pull --rebase origin main || true

          # 双保险：清理 pycache（就算生成也不让它影响提交）
          find . -type d -name "__pycache__" -prune -exec rm -rf {} + || true
          find . -type f -name "*.pyc" -delete || true

          # 也写入 exclude，防止未来其它步骤又生成
          echo "__pycache__/" >> .git/info/exclude
          echo "*.pyc" >> .git/info/exclude

          # ✅ 精准 add：把所有需要落库/发布的产物全纳入
          git add data/pred/pred_top10_latest.csv || true
          git add data/pred/pred_top10_*.csv || true
          git add docs/signals/top10_latest.csv || true

          # ✅ 关键：日报（覆盖版 + 归档版）都纳入
          git add docs/reports/*.md || true
          # 保险：如果未来 reports 里还有子目录或新文件，也能纳入
          git add -A docs/reports || true

          echo "[git] status after add:"
          git status --porcelain || true

          # 仅当有变更时提交
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "auto: update decision signal"
            git push
            echo "[push] done"
          else
            echo "[push] no changes"
          fi
