name: Run Top10 Decision (Auto Daily)

on:
  schedule:
    # Mon-Fri 21:15 Beijing (UTC+8) == 13:15 UTC
    - cron: "15 13 * * 1-5"
  workflow_dispatch:
    inputs:
      trade_date:
        description: "手动指定交易日 YYYYMMDD（留空=使用 a-top10 decisio latest）"
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: top10-decision-daily
  cancel-in-progress: false

jobs:
  decision:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=${GITHUB_WORKSPACE}/src" >> $GITHUB_ENV

      # ✅ 关键：先把会产生/会落库/会发布的目录建好，避免脚本/commit 阶段因为目录不存在而漏产物
      - name: Ensure output dirs
        run: |
          set -e
          mkdir -p data/pred
          mkdir -p data/decision
          mkdir -p docs/signals
          mkdir -p docs/reports
          mkdir -p docs/weights
          mkdir -p outputs/decision
          mkdir -p outputs/learning

      # ✅ 手动指定日期：拉取 a-top10 的 decisio 归档文件 pred_decisio_{trade_date}.csv
      # 保存为 data/pred/pred_source_latest.csv，并让 run_v2.py 走 TOP10_PRED_PATH
      - name: If trade_date provided, fetch pred_decisio_{trade_date}.csv to local cache
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.trade_date != '' }}
        env:
          TRADE_DATE: ${{ inputs.trade_date }}
          A_TOP10_OWNER: njedu2023-prog
          A_TOP10_REPO: a-top10
          A_TOP10_BRANCH: main
        run: |
          set -e

          echo "[manual] trade_date=${TRADE_DATE}"

          # 基础校验：8位数字
          if ! echo "${TRADE_DATE}" | grep -E '^[0-9]{8}$' >/dev/null; then
            echo "[manual] invalid trade_date: ${TRADE_DATE} (expect YYYYMMDD)"
            exit 1
          fi

          mkdir -p data/pred

          FILE_IN_A_TOP10="outputs/decisio/pred_decisio_${TRADE_DATE}.csv"
          RAW_URL="https://raw.githubusercontent.com/${A_TOP10_OWNER}/${A_TOP10_REPO}/${A_TOP10_BRANCH}/${FILE_IN_A_TOP10}"

          echo "[manual] fetching: ${RAW_URL}"

          curl -fL "${RAW_URL}" -o "data/pred/pred_source_latest.csv"

          echo "[manual] saved -> data/pred/pred_source_latest.csv"
          echo "[manual] head:"
          head -n 3 data/pred/pred_source_latest.csv || true
          echo "[manual] lines:"
          wc -l data/pred/pred_source_latest.csv || true

      - name: Run decision pipeline (P0)  # 默认吃 decisio latest；手动则吃本地 pred_source_latest.csv
        env:
          # 默认：a-top10 全量排名（decisio latest）
          TOP10_PRED_URL: https://raw.githubusercontent.com/njedu2023-prog/a-top10/main/outputs/decisio/pred_decisio_latest.csv
          # 手动指定日期时，用本地文件覆盖数据源（run_v2.py 优先用 PATH）
          TOP10_PRED_PATH: ${{ github.event_name == 'workflow_dispatch' && inputs.trade_date != '' && 'data/pred/pred_source_latest.csv' || '' }}
        run: |
          set -e
          python scripts/run_v2.py

      - name: Commit & push outputs (safe)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 先更新远端，避免 push 冲突
          git pull --rebase origin main || true

          # 双保险：清理 pycache（就算生成也不让它影响提交）
          find . -type d -name "__pycache__" -prune -exec rm -rf {} + || true
          find . -type f -name "*.pyc" -delete || true

          # 也写入 exclude，防止未来其它步骤又生成
          echo "__pycache__/" >> .git/info/exclude
          echo "*.pyc" >> .git/info/exclude

          # ✅ 精准 add：把所有需要落库/发布的产物全纳入
          # --- a-top10 全量输入快照（可追溯）
          git add data/pred/pred_source_latest.csv || true

          # --- 保留旧路径的 add（即便未来不再写入也不影响）
          git add data/pred/pred_top10_latest.csv || true
          git add data/pred/pred_top10_*.csv || true

          # --- decision 输出（可执行权重 + 决策报告 + 评估）
          git add docs/weights/weights_latest.csv || true
          git add docs/weights/weights_*.csv || true

          git add outputs/decision/* || true
          git add outputs/decision/**/*.md || true
          git add outputs/decision/**/*.json || true

          # --- 三张必落库表
          git add data/decision/decision_candidates_*.csv || true
          git add data/decision/decision_execution_*.csv || true
          git add data/decision/decision_learning.csv || true

          # ✅ signals：latest + dated（永远新增）都纳入
          git add docs/signals/top10_latest.csv || true
          git add docs/signals/top10_*.csv || true

          # ✅ 日报（覆盖版 + 归档版）都纳入
          git add docs/reports/*.md || true
          git add -A docs/reports || true

          echo "[git] status after add:"
          git status --porcelain || true

          # 仅当有变更时提交
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "auto: update decision signal"
            git push
            echo "[push] done"
          else
            echo "[push] no changes"
          fi
